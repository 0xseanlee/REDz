local HttpService = game:GetService("HttpService")

-- ã€è¨­å®šå€ã€‘
local WebhookURL = "https://discord.com/api/webhooks/1468528458056339529/WKTq9fLdmYaWVaM4b-yy78n9cEP5qB2NQx254k1pMLqJusi6HFefvtBL3vOaKznHoiFH"

print("--- [1] è…³æœ¬å•Ÿå‹•æˆåŠŸ ---")

-- æª¢æŸ¥åŸ·è¡Œå™¨ç’°å¢ƒ
local request = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request
if request then
    print("--- [2] ç’°å¢ƒæª¢æ¸¬ï¼šåŸ·è¡Œå™¨æ”¯æ´ Http Request ---")
else
    warn("--- [2] ç’°å¢ƒæª¢æ¸¬ï¼šâŒ éŒ¯èª¤ï¼ä½ çš„åŸ·è¡Œå™¨ä¸æ”¯æ´ç™¼é€è«‹æ±‚ ---")
end

-- å°è£æ¸¬è©¦ç™¼é€å‡½æ•¸
local function DebugSend(title, content)
    print("--- [æ­¥é©Ÿ] å˜—è©¦ç™¼é€æ•¸æ“šåˆ° Discord: " .. title .. " ---")
    
    local success, err = pcall(function()
        request({
            Url = WebhookURL,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode({
                embeds = {{
                    title = "ğŸ› ï¸ èª¿è©¦è¨Šæ¯: " .. title,
                    description = content,
                    color = 0xFFAA00
                }}
            })
        })
    end)
    
    if success then
        print("--- [çµæœ] âœ… " .. title .. " ç™¼é€æŒ‡ä»¤å·²åŸ·è¡Œ ---")
    else
        warn("--- [çµæœ] âŒ ç™¼é€å¤±æ•—ï¼Œå ±éŒ¯åŸå› : " .. tostring(err) .. " ---")
    end
end

-- ç«‹å³æ¸¬è©¦ Webhook æ˜¯å¦é€£é€š
DebugSend("åˆå§‹é€£ç·šæ¸¬è©¦", "å¦‚æœä½ çœ‹åˆ°é€™å‰‡è¨Šæ¯ï¼Œä»£è¡¨ Webhook ç¶²å€èˆ‡ç¶²è·¯æ¬Šé™æ­£å¸¸ã€‚")

-- ç›£è½å°è©±é‚è¼¯
print("--- [3] é–‹å§‹æ›é‰¤ (Hooking) éŠæˆ²é€šè¨Šå”è­° ---")

local oldNamecall
oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
    local method = getnamecallmethod()
    local args = {...}

    -- ç›£æ§ CommF_
    if tostring(self) == "CommF_" and method == "InvokeServer" then
        if args[1] == "GetQuests" or args[1] == "CheckQuest" then
            print("--- [4] åµæ¸¬åˆ°è§¸ç™¼ NPC å°è©±ï¼æ­£åœ¨æ””æˆªæ•¸æ“š... ---")
            
            task.spawn(function()
                local result = self:InvokeServer(unpack(args))
                if result and type(result) == "table" then
                    print("--- [5] æˆåŠŸè§£æ Table æ•¸æ“šï¼Œæº–å‚™æ ¼å¼åŒ– ---")
                    
                    local list = "local QuestData = {\n"
                    for _, q in pairs(result) do
                        list = list .. string.format('    ["%s"] = {LevelReq = %s},\n', tostring(q.Name), tostring(q.LevelReq or 0))
                    end
                    list = list .. "}"
                    
                    print("--- [6] æ•¸æ“šæ ¼å¼åŒ–å®Œæˆï¼Œç™¼é€è‡³ Discord ---")
                    DebugSend("ä»»å‹™æ•¸æ“šæŠ“å–æˆåŠŸ", "```lua\n" .. list .. "\n```")
                else
                    warn("--- [5] âŒ æ””æˆªå¤±æ•—ï¼šä¼ºæœå™¨å›å‚³äº†ç©ºæ•¸æ“šæˆ–é Table æ ¼å¼ ---")
                end
            end)
        end
    end
    return oldNamecall(self, ...)
end)

print("--- [4] ç›£è½ä¸­... è«‹ç¾åœ¨å»é»æ“Š NPC å°è©±æ¡† ---")
