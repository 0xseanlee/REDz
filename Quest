local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

-- ã€å·²å¡«å…¥ä½ çš„ Webhookã€‘
local WebhookURL = "https://discord.com/api/webhooks/1468528458056339529/WKTq9fLdmYaWVaM4b-yy78n9cEP5qB2NQx254k1pMLqJusi6HFefvtBL3vOaKznHoiFH"

print("--- ä»»å‹™æ•¸æ“šç›£è½å™¨ (Webhookç‰ˆ) å·²å•Ÿå‹• ---")
print("è«‹èˆ‡ NPC å°è©±ï¼Œæ•¸æ“šå°‡åŒæ­¥ç™¼é€è‡³ Discordã€‚")

-- åŸ·è¡Œå™¨å°ˆç”¨ç™¼é€å‡½æ•¸
local function SendToDiscord(taskList)
    local request = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request)
    if request then
        request({
            Url = WebhookURL,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode({
                embeds = {{
                    title = "ğŸ“œ åµæ¸¬åˆ°æ–°ä»»å‹™æ•¸æ“š",
                    description = "```lua\n" .. taskList .. "\n```",
                    color = 0x5865F2, -- Discord è—
                    footer = { text = "ä¾†è‡ªæ•¸æ“šæ¡é›†å·¥å…·" }
                }}
            })
        })
    end
end

-- æ””æˆª CommF_ å”è­°
local oldInvokeServer
oldInvokeServer = hookmetamethod(game, "__namecall", function(self, ...)
    local method = getnamecallmethod()
    local args = {...}

    if tostring(self) == "CommF_" and method == "InvokeServer" then
        -- ç•¶è§¸ç™¼ "GetQuests" (ç²å–æ¸…å–®) æ™‚
        if args[1] == "GetQuests" or args[1] == "CheckQuest" then
            task.spawn(function()
                local result = self:InvokeServer(unpack(args))
                if result and type(result) == "table" then
                    local taskList = "local QuestData = {\n"
                    for _, quest in pairs(result) do
                        taskList = taskList .. string.format(
                            '    ["%s"] = {LevelReq = %s, Reward = %s},\n',
                            tostring(quest.Name), 
                            tostring(quest.LevelReq or "0"), 
                            tostring(quest.RewardMoney or "0")
                        )
                    end
                    taskList = taskList .. "}"
                    
                    -- è¼¸å‡ºåˆ°æ§åˆ¶å°èˆ‡ Discord
                    print(taskList)
                    SendToDiscord(taskList)
                    print("ğŸš€ æ•¸æ“šå·²ç™¼é€åˆ° Discord")
                end
            end)
        end
    end
    return oldInvokeServer(self, ...)
end)
