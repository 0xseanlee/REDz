local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualUser = game:GetService("VirtualUser")
local player = Players.LocalPlayer
local root = player.Character.HumanoidRootPart

-- ã€ä»»å‹™æ¸…å–®ï¼šæˆ‘å€‘æ‰‹å‹•å®‰æ’çš„é †åºã€‘
-- æ ¼å¼ï¼š{ä»»å‹™çµ„å, ä»»å‹™ID, æ€ªç‰©åç¨±, NPCåº§æ¨™}
local QuestSequence = {
    [1] = {
        Name = "BanditQuest1", 
        ID = 1, 
        Mob = "Bandit", 
        NPC_Pos = CFrame.new(1059, 16, 1549) -- èµ·å§‹å³¶ç›œè³Š NPC
    },
    [2] = {
        Name = "JungleQuest", 
        ID = 1, 
        Mob = "Monkey", 
        NPC_Pos = CFrame.new(-1598, 36, 153) -- å¢æ—å†’éšªå®¶ NPC
    },
    [3] = {
        Name = "JungleQuest", 
        ID = 2, 
        Mob = "Gorilla", 
        NPC_Pos = CFrame.new(-1598, 36, 153) -- å¢æ—å†’éšªå®¶ NPC (åŒä¸€å€‹)
    },
    [4] = {
        Name = "SnowQuest", 
        ID = 1, 
        Mob = "Snow Bandit", 
        NPC_Pos = CFrame.new(1386, 87, -1298) -- é›ªå³¶ NPC
    }
}

-- ã€ç‹€æ…‹è®Šæ•¸ã€‘
local CurrentStep = 1 -- å¾ç¬¬ 1 æ­¥é–‹å§‹
local IsQuestTaken = false

print("--- ğŸ¬ ä¸€æµ·æµç¨‹æ¸¬è©¦å™¨å•Ÿå‹• (å¿½ç•¥ç­‰ç´šæ¨¡å¼) ---")

-- 1. åŸºç¤å·¥å…·ï¼šè£å‚™æ­¦å™¨
local function EquipCDK()
    local tool = player.Backpack:FindFirstChild("Cursed Dual Katana") or player.Backpack:FindFirstChild("Godhuman")
    if tool then player.Character.Humanoid:EquipTool(tool) end
end

-- 2. åŸºç¤å·¥å…·ï¼šæª¢æŸ¥ä»»å‹™æ¬„
local function HasQuest()
    local gui = player.PlayerGui.Main:FindFirstChild("Quest")
    return gui and gui.Visible
end

-- 3. æ ¸å¿ƒï¼šç§»å‹•èˆ‡æ¥ä»»å‹™
local function ProcessStep()
    local taskData = QuestSequence[CurrentStep]
    
    if not taskData then
        print("ğŸ‰ æ¸¬è©¦æ¸…å–®ä¸Šçš„æ‰€æœ‰ä»»å‹™å·²å®Œæˆï¼")
        return
    end

    if not HasQuest() then
        -- ã€éšæ®µ Aï¼šå»æ¥ä»»å‹™ã€‘
        print(string.format("ğŸ“ [æ­¥é©Ÿ %d] å‰å¾€æ¥å–: %s (%s)", CurrentStep, taskData.Name, taskData.Mob))
        
        -- 1. ç¬ç§»åˆ° NPC
        root.CFrame = taskData.NPC_Pos
        task.wait(0.5) -- ç­‰å¾…è·é›¢åˆ¤å®š
        
        -- 2. ç™¼é€è«‹æ±‚
        ReplicatedStorage.Remotes.CommF_:InvokeServer("AbandonQuest") -- å…ˆæ”¾æ£„èˆŠçš„é˜²æ­¢å¡ä½
        ReplicatedStorage.Remotes.CommF_:InvokeServer("StartQuest", taskData.Name, taskData.ID)
        
        task.wait(1)
        if HasQuest() then
            print("âœ… ä»»å‹™æ¥å–æˆåŠŸï¼æº–å‚™æˆ°é¬¥")
            IsQuestTaken = true
        end
    else
        -- ã€éšæ®µ Bï¼šå»æ‰“æ€ªã€‘
        if not IsQuestTaken then IsQuestTaken = true end -- ç¢ºä¿ç‹€æ…‹åŒæ­¥
        
        -- 1. æœå°‹åœ°åœ–ä¸Šçš„æ€ªç‰©
        local target = nil
        for _, enemy in pairs(game.Workspace.Enemies:GetChildren()) do
            if enemy.Name == taskData.Mob and enemy:FindFirstChild("Humanoid") and enemy.Humanoid.Health > 0 then
                target = enemy
                break
            end
        end
        
        if target then
            -- 2. ç¬ç§»åˆ°æ€ªç‰©é ­ä¸Š (Y + 5)
            EquipCDK()
            root.CFrame = target.HumanoidRootPart.CFrame * CFrame.new(0, 5, 0)
            
            -- 3. è‡ªå‹•æ”»æ“Š
            VirtualUser:CaptureController()
            VirtualUser:Button1Down(Vector2.new(1280, 672))
            
            print("âš”ï¸ æ­£åœ¨æ”»æ“Š: " .. taskData.Mob)
        else
            -- æ²’æ€ªçš„æ™‚å€™ï¼Œæ‡¸åœåœ¨æ€ªå€ä¸Šæ–¹ç­‰å¾…åˆ·æ–°
            -- é€™è£¡ç°¡å–®è™•ç†ï¼šå¦‚æœæ‰¾ä¸åˆ°æ€ªï¼Œå°±åœåœ¨ NPC é™„è¿‘ä¸Šæ–¹ç­‰å¾…
            root.CFrame = taskData.NPC_Pos * CFrame.new(0, 30, 0)
            print("â³ ç­‰å¾…æ€ªç‰©åˆ·æ–°ä¸­...")
        end
    end
end

-- 4. ç›£æ§èˆ‡é€²åº¦åˆ‡æ›
task.spawn(function()
    while true do
        local success, err = pcall(function()
            -- åˆ¤å®šä»»å‹™å®Œæˆï¼šåŸæœ¬æœ‰æ¥ä»»å‹™(IsQuestTaken=true)ï¼Œç¾åœ¨æ²’ä»»å‹™äº†(HasQuest=false)
            if IsQuestTaken and not HasQuest() then
                print("âœ¨ æ­¥é©Ÿ " .. CurrentStep .. " å®Œæˆï¼æ™‰ç´šä¸‹ä¸€æ­¥...")
                CurrentStep = CurrentStep + 1
                IsQuestTaken = false
                task.wait(2) -- ä¼‘æ¯ä¸€ä¸‹
            else
                ProcessStep()
            end
        end)
        
        if not success then warn("è…³æœ¬éŒ¯èª¤: " .. err) end
        task.wait(0.2)
    end
end)
