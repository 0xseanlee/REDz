-- [[ ç³»çµ±æœå‹™è¨­å®š ]]
local webhook_url = "https://discord.com/api/webhooks/1468906393732911158/DJ-MJe9W8gNe0lj9QyRdZ-TV6wCT43Z43Qo_Nze77PoyGhuC5J4wjK78adrw1fFt9bW4"
local player = game.Players.LocalPlayer
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- --- 1. è‡ªå‹•é¸æ“‡æµ·è³Š (Auto Pick Side) ---
local function autoPickSide()
    local success, err = pcall(function()
        if not player:FindFirstChild("DataLoaded") then
            -- å‘¼å«éŠæˆ²å…§éƒ¨çš„é¸é‚Šå”è­°ï¼Œç›´æ¥åŠ å…¥æµ·è³Š
            ReplicatedStorage.Remotes.CommF_:InvokeServer("SetTeam", "Pirates")
        end
    end)
    return success
end

-- --- Discord ç™¼é€å‡½æ•¸ ---
local function sendWebhook(title, description, color)
    local request_func = syn and syn.request or http_request or request or (http and http.request)
    if not request_func then return end

    local data = {
        ["embeds"] = {{
            ["title"] = title,
            ["description"] = description,
            ["color"] = color or 16711680,
            ["footer"] = {["text"] = "ä¼ºæœå™¨æ™‚é–“: " .. os.date("%X")},
            ["fields"] = {
                {["name"] = "ä¼ºæœå™¨ ID", ["value"] = "```" .. game.JobId .. "```", ["inline"] = false},
                {["name"] = "ç©å®¶äººæ•¸", ["value"] = #game.Players:GetChildren() .. "/" .. game.Players.MaxPlayers, ["inline"] = true}
            }
        }}
    }

    pcall(function()
        request_func({
            Url = webhook_url,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(data)
        })
    end)
end

-- --- è‡ªå‹•æ›æœå‡½æ•¸ ---
local function ServerHop()
    local PlaceID = game.PlaceId
    pcall(function()
        local Servers = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. PlaceID .. "/servers/Public?sortOrder=Asc&limit=100"))
        for _, s in pairs(Servers.data) do
            if s.playing < s.maxPlayers and s.id ~= game.JobId then
                TeleportService:TeleportToPlaceInstance(PlaceID, s.id, player)
                break
            end
        end
    end)
end

-- --- å¹³æ»‘é£›è¡Œ ---
local function teleport(targetCFrame)
    local char = player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    local dist = (char.HumanoidRootPart.Position - targetCFrame.Position).Magnitude
    local speed = 300
    local tween = TweenService:Create(char.HumanoidRootPart, TweenInfo.new(dist/speed, Enum.EasingStyle.Linear), {CFrame = targetCFrame})
    tween:Play()
    return tween
end

-- --- ä¸»åŸ·è¡Œé‚è¼¯ ---
task.spawn(function()
    -- A. ç­‰å¾…éŠæˆ²è¼‰å…¥ä¸¦è‡ªå‹•é¸é‚Š
    repeat task.wait() until game:IsLoaded()
    task.wait(2)
    autoPickSide()
    
    -- B. ç­‰å¾…è§’è‰²ç”Ÿæˆ
    repeat task.wait() until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    task.wait(3) 
    
    -- C. æƒææœå¯¦
    local fruits = {}
    for _, obj in pairs(game.Workspace:GetChildren()) do
        if obj:IsA("Tool") and (obj.Name:find("Fruit") or obj:FindFirstChild("Handle")) then
            table.insert(fruits, obj)
        end
    end
    
    -- D. æ ¹æ“šæƒæçµæœè¡Œå‹•
    if #fruits > 0 then
        sendWebhook("ğŸŒŸ ç™¼ç¾æœå¯¦ï¼", "æ­¤ä¼ºæœå™¨æœ‰ **" .. #fruits .. "** å€‹æœå¯¦ï¼Œæ­£åœ¨å‰å¾€æ’¿å–...", 65280)
        
        for _, fruit in pairs(fruits) do
            local handle = fruit:FindFirstChild("Handle") or fruit:FindFirstChildOfClass("Part")
            if handle then
                local tw = teleport(handle.CFrame)
                if tw then tw.Completed:Wait() end
                
                task.wait(1.5) -- ç‰©ç†ç¢°è§¸
                
                local fruitName = fruit.Name
                pcall(function()
                    ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit", fruitName, player.Character:FindFirstChild(fruitName))
                end)
                
                sendWebhook("ğŸ æˆåŠŸæ”¶å…¥èƒŒåŒ…", "å·²å­˜å…¥æœå¯¦: **" .. fruitName .. "**", 16776960)
                task.wait(1)
            end
        end
    else
        sendWebhook("ğŸ” æƒæå®Œç•¢", "æ­¤ä¼ºæœå™¨ç„¡æœå¯¦ï¼Œå³å°‡è‡ªå‹•æ›æœã€‚", 16711680)
    end
    
    -- E. çµæŸå¾Œæ›æœ
    task.wait(3)
    ServerHop()
end)
