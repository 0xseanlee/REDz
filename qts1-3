local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local player = game.Players.LocalPlayer
local vUser = game:GetService("VirtualUser")

-- ã€è¨­å®šå€ã€‘
local TWEEN_SPEED = 300 
local WEAPON_NAME = "Cursed Dual Katana" -- ä½ ç›®å‰çš„é ‚ç´šæ­¦å™¨

local QuestChain = {
    {Name = "JungleQuest", ID = 1, Mob = "Monkey", Pos = CFrame.new(-1598, 36, 153)},
    {Name = "SnowQuest", ID = 1, Mob = "Snow Bandit", Pos = CFrame.new(1386, 87, -1298)}
}

-- 1. ğŸ”¥ å¼·åŒ–ç‰ˆè‡ªå‹•æ™®æ”» (è§£æ±º Auto M1 ä¸å‹•çš„å•é¡Œ)
local function UltimateClick()
    -- æ–¹æ³• A: æ¨¡æ“¬é¼ æ¨™é»æ“Š
    vUser:CaptureController()
    vUser:Button1Down(Vector2.new(1280, 672))
    
    -- æ–¹æ³• B: ç›´æ¥èª¿ç”¨å·¥å…·æ¿€æ´» (ä¿éšªæ©Ÿåˆ¶)
    local tool = player.Character:FindFirstChildOfClass("Tool")
    if tool then
        tool:Activate()
    end
end

-- 2. è£å‚™æ­¦å™¨
local function EquipWeapon()
    local tool = player.Backpack:FindFirstChild(WEAPON_NAME)
    if tool then
        player.Character.Humanoid:EquipTool(tool)
    end
end

-- 3. é˜²æ‹‰å›ç§»å‹•
local function SafeMove(targetCFrame)
    local root = player.Character:WaitForChild("HumanoidRootPart")
    local distance = (root.Position - targetCFrame.p).Magnitude
    local tween = TweenService:Create(root, TweenInfo.new(distance/TWEEN_SPEED, Enum.EasingStyle.Linear), {CFrame = targetCFrame})
    local bv = Instance.new("BodyVelocity", root)
    bv.Velocity = Vector3.new(0,0,0)
    tween:Play()
    tween.Completed:Wait()
    bv:Destroy()
end

-- 4. æ ¸å¿ƒæ›æ©Ÿå¾ªç’°
task.spawn(function()
    local currentIndex = 1
    while true do
        local q = QuestChain[currentIndex]
        
        -- A. æª¢æŸ¥ä»»å‹™
        if not player.PlayerGui.Main.Quest.Visible then
            SafeMove(q.Pos)
            task.wait(0.5)
            ReplicatedStorage.Remotes.CommF_:InvokeServer("StartQuest", q.Name, q.ID)
        end

        -- B. æˆ°é¬¥å¾ªç’° (ä¸ä½¿ç”¨ Bringï¼Œæ”¹ç‚ºè²¼èº«è‚‰æ)
        while player.PlayerGui.Main.Quest.Visible do
            EquipWeapon()
            
            -- å°‹æ‰¾æœ€è¿‘çš„ç›®æ¨™æ€ªç‰©
            local target = nil
            for _, v in pairs(game.Workspace.Enemies:GetChildren()) do
                if v.Name == q.Mob and v:FindFirstChild("HumanoidRootPart") and v.Humanoid.Health > 0 then
                    target = v
                    break
                end
            end

            if target then
                -- é£›åˆ°æ€ªç‰©çš„æ­£ä¸Šæ–¹æˆ–å´é¢ (é¿é–‹ç¢°æ’)
                player.Character.HumanoidRootPart.CFrame = target.HumanoidRootPart.CFrame * CFrame.new(0, 5, 0)
                UltimateClick() -- åŸ·è¡Œå¼·åŒ–æ™®æ”»
            else
                -- æ²’æ€ªæ™‚å›ä»»å‹™é»ä¸Šæ–¹ç­‰å¾…
                player.Character.HumanoidRootPart.CFrame = q.Pos * CFrame.new(0, 20, 0)
            end
            task.wait(0.1) -- æ”»é€Ÿè¨­å®š
        end
        
        currentIndex = (currentIndex % #QuestChain) + 1
        task.wait(1)
    end
end)
